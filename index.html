<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="d3/d3.js"></script>
  <style>
    h2 {
      color: black;
    }
    .grid line {
      stroke: lightgrey;
      stroke-dasharray: 3;
      stroke-opacity: 0.5;
      shape-rendering: crispEdges;
    }
    .grid path {
      stroke-width: 0;
    }
    div.buttons {
      text-align: center;
      font-size: small;
      background-color: lightgray;
      border: 1px solid black;
      padding: 3px;
      margin: 5px;
    }
    div.button_container {
      align: center;
    }
  </style>
  </head>


<body>
  <script type="text/javascript">
    function draw(data) {
        "use strict";

        var margin = {top: 50, right: 30, bottom: 50, left: 70},
            chartwidth = 500,
            chartheight = 500,
            canvaswidth = chartwidth + margin.right + margin.left,
            canvasheight = chartheight + margin.top + margin.bottom;


        d3.select("body") // add a title
          .append('h2')
          .text("Parasite life cycles");

        // create container for buttons
        var button_container = d3.select("body")
          .append("div")
          .attr('class', 'button_container')
          .attr('width', canvaswidth)

        // create buttons for interactivity
        var buttons = button_container.selectAll("div")
          .data(["Random species", "1-host cycles", "2-host cycles", "3-host cycles", "4+ host cycles",
                "To intermediate host", "To definitive host", "To facultative host", "To humans"])
          .enter()
          .append('div')
          .attr('class', 'buttons')
          .text(function(d) {return d;})
          .style('width', chartwidth / 5 + "px")
          .style('float', 'left')



        // create svg as last element within body
        var svg = d3.select("body")
            .append("svg")
            .attr("width", canvaswidth)
            .attr("height", canvasheight);


        // create scales
        var xscale = d3.scalePoint()
          .domain(["propagule", "1st", "2nd", "3rd", "4th", "5th"])
          .range([margin.left, chartwidth]) // scale from margin to width
          .padding(0.2)
        var yscale = d3.scaleLog()
          .range([chartheight, margin.bottom]) // (inverse) scale from height (bottom) to upper marginn
          .domain(d3.extent(data, function(d) {
            return d['Biovolume']
          }));
        var colscale = d3.scaleOrdinal(d3.schemeCategory10);

        // define axes
        var xaxis = d3.axisBottom(xscale);
        var yaxis = d3.axisLeft(yscale);

        // add axes to the svg element
        svg.append('g') // add x-axis
          .attr('class', 'x axis')
          .attr('transform', "translate(0," + chartheight + ")")
          .call(xaxis);
        svg.append("text") // add title
          .attr('class', 'x title')
          .attr("text-anchor", "middle")
          .attr("transform", "translate("+ (chartwidth/2) + "," + (chartheight + (margin.bottom/1.5)) +")")  // centre below axis
          .text('Host in cycle');
        svg.append('g') // add y-axis
          .attr('class', 'y axis')
          .attr('transform', "translate(" + margin.left + ",0)")
          .call(yaxis.ticks(5));
        svg.append("g") // add y-grid
            .attr("class", "grid")
            .attr('transform', "translate(" + margin.left + ",0)")
            .call(yaxis.ticks(5)
                .tickSize(-chartwidth + margin.right)
                .tickFormat("")
            )
        svg.append('text') // add title
          .attr('class', 'y title')
          .attr("text-anchor", "middle")
          .attr("transform", "translate("+ (margin.left/3) +"," + (chartheight/2) + ") rotate(-90)")
          .text('Biovolume');



        // plot points
        svg.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr('cx', function(d) {
            return xscale(d['Host.nofac']);
          })
          .attr('cy', function(d) {
            return yscale(d['Biovolume']); // need to filter out NaN values
          })
          .attr('r', 3)
          .attr('fill', function(d) {
            return colscale(d['maxLCL']);
          })
          .attr('opacity', 0.05);

        // group data by parasite species
        var psdata = d3.nest()
          .key(function(d) {return d['Parasite.species']})
          .entries(data)

        // create function for connecting data points
        var drawLine = d3.line()
          .x(function(d) {return xscale(d['Host.nofac'])})
          .y(function(d) {return yscale(d['Biovolume'])});

        // add lines for each species
        svg.selectAll('path')
          .data(psdata)
          .enter()
          .append('path')
          .attr("class", "species lines")
          .attr("id", function(d) {return d.key})
          .attr("d", function(d) {return drawLine(d.values)})
          .attr("stroke", function(d) {
            return colscale(d.values[0]['maxLCL'])})
          .attr("stroke-width", 1)
          .attr("stroke-opacity", 0.1)
          .attr("fill", "none");



        // update color scheme based on click of button
        d3.select(".buttons")
          .on('click', function() {
            // update color scheme for points
            svg.selectAll("circle")
              .transition()
              .duration(1500)
              .attr('fill', function(d) {
                if(d['Parasite.species'] == "Schistocephalus solidus") {
                  return 'red';
                } else {
                  return 'gray'
                }
                //return colscale(d['minLCL']);
              })
              .attr('opacity', function(d) {
                if(d['Parasite.species'] == "Schistocephalus solidus") {
                  return 1;
                }
              })
              .attr('r', function(d) {
                if(d['Parasite.species'] == "Schistocephalus solidus") {
                  return 10;
                }
              })
            // update color scheme for lines
            svg.selectAll('.species.lines')
              .transition()
              .duration(1500)
              .attr("stroke", function(d) {
                if(d.key == "Schistocephalus solidus") {
                  return 'red';
                } else {
                  return 'gray'
                }
                //return colscale(d.values[0]['minLCL']);
              });

          })


        } //end of draw function


  </script>

  <script type="text/javascript">
  /*
    Use D3 to load the data
    */

  d3.csv("data.csv", function(d) { //d refers to row in csv file
    d['maxLCL'] = +d['maxLCL']; // 'unary' operator converts strings to number; Javscript trick
    d['Biovolume'] = +d['Biovolume'];
    if(!isNaN(d['Biovolume'])) {return d}; // remove all rows where biovolume couldn't be coerced to a number
  }, draw);
  </script>
</body>
</html>
