<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="d3/d3.js"></script>
  <style>
    h2 {
      color: 'red';
      }
  </style>
  </head>


<body>
  <script type="text/javascript">
    function draw(data) {
        "use strict";

        var margin = {top: 50, right: 30, bottom: 50, left: 70},
            width = 500,
            height = 500;

        d3.select("body") // add a title
          .append('h2')
          .text("Parasite life cycles");

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);


        // create scales
        var xscale = d3.scalePoint()
          .domain(["propagule", "1st", "2nd", "3rd", "4th", "5th"])
          .range([margin.left, width]) // scale from margin to width
          .padding(0.2)
        var yscale = d3.scaleLog()
          .range([height, margin.bottom]) // (inverse) scale from height (bottom) to upper marginn
          .domain(d3.extent(data, function(d) {
            return d['Biovolume']
          }));
        var colscale = d3.scaleOrdinal(d3.schemeCategory10);

        // define axes
        var xaxis = d3.axisBottom(xscale);
        var yaxis = d3.axisLeft(yscale);

        // add axes to the svg element
        svg.append('g')
          .attr('class', 'x axis')
          .attr('transform', "translate(0," + height + ")")
          .call(xaxis);
        svg.append("text") // add title
          .attr('class', 'x title')
          .attr("text-anchor", "middle")
          .attr("transform", "translate("+ (width/2) + "," + (height + (margin.bottom/1.5)) +")")  // centre below axis
          .text('Host in cycle');

        svg.append('g')
          .attr('class', 'y axis')
          .attr('transform', "translate(" + margin.left + ",0)")
          .call(yaxis);
        svg.append('text') // add title
          .attr('class', 'y title')
          .attr("text-anchor", "middle")
          .attr("transform", "translate("+ (margin.left/3) +"," + (height/2) + ") rotate(-90)")
          .text('Biovolume');



        // plot points
        svg.selectAll("circle")
          .data(data)
          .enter()
          .append("circle")
          .attr('cx', function(d) {
            return xscale(d['Host.nofac']);
          })
          .attr('cy', function(d) {
            return yscale(d['Biovolume']); // need to filter out NaN values
          })
          .attr('r', 3)
          .attr('fill', function(d) {
            return colscale(d['maxLCL']);
          })
          .attr('opacity', 0.05);

        // group data by parasite species
        var psdata = d3.nest()
          .key(function(d) {return d['Parasite.species']})
          .entries(data)

        // create function for connecting data points
        var drawLine = d3.line()
          .x(function(d) {return xscale(d['Host.nofac'])})
          .y(function(d) {return yscale(d['Biovolume'])});

        // add line to chart
        psdata.forEach(function(d) {
          svg.append('path')
            .attr("class", "species lines")
            .attr("d", drawLine(d.values))
            .attr("stroke", colscale(d.values[0]['maxLCL']))
            .attr("stroke-width", 1)
            .attr("stroke-opacity", 0.1)
            .attr("fill", "none");
        });


        } //end of draw function


  </script>

  <script type="text/javascript">
  /*
    Use D3 to load the data
    */

  d3.csv("data.csv", function(d) { //d refers to row in csv file
    d['maxLCL'] = +d['maxLCL']; // 'unary' operator converts strings to number; Javscript trick
    d['Biovolume'] = +d['Biovolume'];
    if(!isNaN(d['Biovolume'])) {return d}; // remove all rows where biovolume couldn't be coerced to a number
  }, draw);
  </script>
</body>
</html>
